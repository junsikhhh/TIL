# 6.12 [LCA]

## LCA(Lowest Common Ancestor) ì•Œê³ ë¦¬ì¦˜

ìµœì†Œ ê³µí†µ ì¡°ìƒ

íŠ¸ë¦¬ êµ¬ì¡°ì—ì„œ ìž„ì˜ì˜ ë‘ ì •ì ì´ ê°–ëŠ” ê°€ìž¥ ê°€ê¹Œìš´ ì¡°ìƒ ì •ì ì„ ì˜ë¯¸í•œë‹¤.

ë…¸ë“œ ìˆ˜ : N

ì¿¼ë¦¬ ìˆ˜ : M

### 1. ì„ í˜• íƒìƒ‰ [O(MN)]

ë‘ í¬ì¸í„°ë¥¼ ë‘ê³  ê°€ë¦¬í‚¤ëŠ” ì •ì ì´ ê°™ì•„ì§ˆ ë•Œê¹Œì§€ ë¶€ëª¨ ë…¸ë“œë¡œ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°„ë‹¤.

> **ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ê¸° ì „ êµ¬í•˜ê³ ìž í•˜ëŠ”Â ë‘ ì •ì ì˜ LEVEL(ê¹Šì´)ë¥¼ ê°™ê²Œ í•´ì•¼ í•œë‹¤.**
> 

### 2. ì´ë¶„ íƒìƒ‰ [O(MlogN)]

Parent ë°°ì—´ì„ 2ì°¨ì›ìœ¼ë¡œ ë‘ì–´,Â **Parent[x][k] = "xë²ˆ ì •ì ì˜ 2^kë²ˆì§¸ ì¡°ìƒ ë…¸ë“œì˜ ë²ˆí˜¸"**Â ë¡œ ë‘”ë‹¤.

- **k ë²ˆì§¸ ì¡°ìƒ** : level = (2^k)ê±°ë¦¬ë¥¼ ì˜ë¯¸
  
    Ex. k = 0 ì´ë©´ 2 ^ 0 = 1 ì´ë¯€ë¡œ, ì²« ë²ˆì§¸ ê±°ë¦¬ì— ìžˆëŠ” ì¡°ìƒì„ ì˜ë¯¸
    
- **ì¡°ìƒì„ íƒìƒ‰í•˜ëŠ” ì í™”ì‹**
    - `DP[index][a]` = index ë…¸ë“œì˜ 2^a ë²ˆì§¸ ë¶€ëª¨ë…¸ë“œ
    
    ```
    DP[index][a] = DP[DP[index][a-1]][a-1]
    ```
    

**ðŸ“ ê²°êµ­, íƒìƒ‰ì„ ìœ„í•´ì„œëŠ” ë‘ ë…¸ë“œì˜ ê¹Šì´(level)ì„ ë§žì¶°ì•¼ í•œë‹¤.**

ì´ë¥¼ ìœ„í•´ì„œ, ì„ í˜• í˜¹ì€ ì´ë¶„ íƒìƒ‰ìœ¼ë¡œ ê¹Šì´ ë§žì¶”ëŠ” ì—°ì‚° ì†ë„ë¥¼ ë¹ ë¥´ê²Œ í•˜ëŠ” ê²ƒì´ ê´€ê±´ì´ë‹¤.

ë”°ë¼ì„œ, ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” level ì •ë³´ì™€ ê°ìžì˜ ë¶€ëª¨ ì •ë³´ê°€ í•„ìš”í•˜ë‹¤.

1. levelì„ ì„œë¡œ ë§žì¶”ê³ 
2. ë¶€ëª¨ê°€ ê°™ì€ì§€ í™•ì¸í•œë‹¤.

```python
import sys, math
sys.setrecursionlimit(10 ** 5)
input = sys.stdin.readline

def solution():
    N = int(input())
    L = math.ceil(math.log2(N))

    graph = [[] for _ in range(N + 1)]
    for _ in range(N - 1):
        a, b = map(int, input().split())
        graph[a].append(b)
        graph[b].append(a)

    par = [[0 for _ in range(L)] for _ in range(N + 1)]
    depth = [0 for _ in range(N + 1)]
    visited = [0 for _ in range(N + 1)]

    def dfs(x, d):
        visited[x] = 1
        depth[x] = d
        for nxt in graph[x]:
            if visited[nxt]:
                continue
            par[nxt][0] = x
            dfs(nxt, d + 1)

    def set_parent(L, N):
        for i in range(1, L):
            for j in range(1, N + 1):
                # ë‚´ 2 ^ i ë²ˆì§¸ ë¶€ëª¨ëŠ” 2 ^ (i - 1) ë¶€ëª¨ì˜ 2 ^ (i - 1)ë²ˆì§¸ ë¶€ëª¨ì´ë‹¤.
                par[j][i] = par[par[j][i - 1]][i - 1]

    def LCA(a, b, L):
        # bê°€ ë” ê¹ŠìŒ
        if depth[a] > depth[b]:
            a, b = b, a

        # 1. level ë§žì¶”ê¸°
        for i in range(L - 1, -1, -1):
            if depth[b] - depth[a] >= (1 << i):
                b = par[b][i]

        # 2. ê°™ì€ ì¡°ìƒ ì°¾ê¸°
        if a == b:
            return a
        for i in range(L - 1, -1, -1):
            if par[a][i] != par[b][i]:
                a, b = par[a][i], par[b][i]

        return par[a][0]

    dfs(1, 0)
    set_parent(L, N)

    M = int(input())
    for _ in range(M):
        a, b = map(int, input().split())
        print(LCA(a, b, L))

solution()
```